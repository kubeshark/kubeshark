---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app.kubeshark.co/app: hub
    sidecar.istio.io/inject: "false"
    {{- include "kubeshark.labels" . | nindent 4 }}
  annotations:
  {{- if .Values.tap.annotations }}
    {{- toYaml .Values.tap.annotations | nindent 4 }}
  {{- end }}
  name: kubeshark-hub
  namespace: {{ .Release.Namespace }}
spec:
  containers:
    - command:
        - ./hub
        {{ .Values.tap.debug | ternary "- -debug" "" }}
      env:
        - name: POD_REGEX
          value: '{{ .Values.tap.regex }}'
        - name: NAMESPACES
          value: '{{ gt (len .Values.tap.namespaces) 0 | ternary (join "," .Values.tap.namespaces) "" }}'
        - name: LICENSE
          value: '{{ .Values.license }}'
        - name: SCRIPTING_ENV
          value: '{{ .Values.scripting.env | toJson }}'
        - name: SCRIPTING_SCRIPTS
          value: '[]'
        - name: AUTH_ENABLED
          value: '{{ .Values.tap.auth.enabled | ternary "true" "" }}'
        - name: AUTH_APPROVED_EMAILS
          value: '{{ gt (len .Values.tap.auth.approvedemails) 0 | ternary (join "," .Values.tap.auth.approvedemails) "" }}'
        - name: AUTH_APPROVED_DOMAINS
          value: '{{ gt (len .Values.tap.auth.approveddomains) 0 | ternary (join "," .Values.tap.auth.approveddomains) "" }}'
      image: '{{ .Values.tap.docker.registry }}/hub:{{ .Values.tap.docker.tag }}'
      imagePullPolicy: {{ .Values.tap.docker.imagepullpolicy }}
      name: kubeshark-hub
      resources:
        limits:
          cpu: {{ .Values.tap.resources.hub.limits.cpu }}
          memory: {{ .Values.tap.resources.hub.limits.memory }}
        requests:
          cpu: {{ .Values.tap.resources.hub.requests.cpu }}
          memory: {{ .Values.tap.resources.hub.requests.memory }}
  dnsPolicy: ClusterFirstWithHostNet
  serviceAccountName: {{ include "kubeshark.serviceAccountName" . }}
  terminationGracePeriodSeconds: 0
  tolerations:
    - effect: NoExecute
      operator: Exists
{{- if not .Values.tap.ignoretainted }}
    - effect: NoSchedule
      operator: Exists
{{- end }}
status: {}
